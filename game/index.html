<!DOCTYPE html>
<html>
<head>
    <title>Advanced 3D Web Gun Shooter</title>
    <style>
        body { margin: 0; overflow: hidden; }
        canvas { display: block; }
        #ammo-display {
            position: absolute;
            bottom: 10px;
            left: 10px;
            color: white;
            font-size: 24px;
            font-family: sans-serif;
            text-shadow: 2px 2px 4px #000000;
        }
        #health-display {
            position: absolute;
            bottom: 40px;
            left: 10px;
            color: white;
            font-size: 24px;
            font-family: sans-serif;
            text-shadow: 2px 2px 4px #000000;
        }
        #prompt-display {
            position: absolute;
            top: 40%;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 28px;
            font-family: sans-serif;
            text-shadow: 2px 2px 4px #000000;
            display: none;
        }
        #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            color: red;
            font-size: 80px;
            font-family: sans-serif;
            display: none;
            justify-content: center;
            align-items: center;
            text-align: center;
            flex-direction: column;
        }
        #game-over small {
            font-size: 24px;
            color: white;
        }
    </style>
</head>
<body>
    <div id="ammo-display">Ammo: 30</div>
    <div id="health-display">Health: 100</div>
    <div id="prompt-display">Press 'E' to enter Tank</div>
    <div id="game-over">
        GAME OVER
        <small>Refresh to restart</small>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // OBJLoader needs to be hosted or loaded from a CDN.
        const OBJLoader_URL = 'https://cdn.jsdelivr.net/gh/mrdoob/three.js@r128/examples/js/loaders/OBJLoader.js';

        let scene, camera, renderer, player, gun, tank, tankTurret;
        let enemies = [];
        let bullets = [];
        let enemyBullets = [];
        let tankShells = [];
        let pillars = [];
        let ammo = 30;
        let playerHealth = 100;

        // UI Elements
        const ammoDisplay = document.getElementById('ammo-display');
        const healthDisplay = document.getElementById('health-display');
        const promptDisplay = document.getElementById('prompt-display');
        const gameOverScreen = document.getElementById('game-over');

        const keys = {};
        let isInTank = false;
        let enemyModel = null;
        let textures = {};
        let sounds = {};
        let listener;
        let isGameOver = false;

        // Player physics
        const playerVelocity = new THREE.Vector3();
        const gravity = -0.015;
        let onGround = false;

        // Gun animation
        let isRecoiling = false;
        let recoilClock = new THREE.Clock();

        const script = document.createElement('script');
        script.src = OBJLoader_URL;
        document.head.appendChild(script);
        script.onload = () => {
             loadAssets();
        };


        function loadAssets() {
            const loadingManager = new THREE.LoadingManager(() => {
                init();
                animate();
            });
            const textureLoader = new THREE.TextureLoader(loadingManager);
            const objLoader = new THREE.OBJLoader(loadingManager);
            const audioLoader = new THREE.AudioLoader(loadingManager);
            
            listener = new THREE.AudioListener();

            textures.grass = textureLoader.load('assets/grass.png');
            textures.brown = textureLoader.load('assets/brown.png');
            textures.bullet = textureLoader.load('assets/bullet.png');
            textures.gun = textureLoader.load('assets/gun.png');
            textures.tank = textureLoader.load('assets/tank.png');
            textures.enemy = textureLoader.load('assets/enemy.png');
            textures.sky = textureLoader.load('assets/sky.png');

            objLoader.load('assets/enemy.obj', (obj) => {
                const enemyMaterial = new THREE.MeshStandardMaterial({ map: textures.enemy });
                obj.traverse((child) => {
                    if (child.isMesh) {
                        child.material = enemyMaterial;
                        child.castShadow = true;
                    }
                });
                obj.scale.set(0.5, 0.5, 0.5);
                enemyModel = obj;
            });
            
            const soundPaths = ['gun.mp3', 'enemygun.mp3', 'jump.mp3', 'fallinggrass.mp3', 'fallingonmetal.mp3'];
            soundPaths.forEach(path => {
                const key = path.split('.')[0];
                audioLoader.load(`assets/${path}`, (buffer) => {
                    sounds[key] = new THREE.Audio(listener).setBuffer(buffer);
                });
            });
        }


        function init() {
            // Scene
            scene = new THREE.Scene();

            // Camera & Audio Listener
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.add(listener);

            // Skybox
            const skyGeometry = new THREE.SphereGeometry(500, 60, 40);
            skyGeometry.scale(-1, 1, 1);
            const skyMaterial = new THREE.MeshBasicMaterial({ map: textures.sky });
            const skybox = new THREE.Mesh(skyGeometry, skyMaterial);
            scene.add(skybox);

            // Renderer
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.shadowMap.enabled = true;
            document.body.appendChild(renderer.domElement);

            // Lighting
            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(10, 20, 5);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            // Map
            textures.grass.wrapS = THREE.RepeatWrapping;
            textures.grass.wrapT = THREE.RepeatWrapping;
            textures.grass.repeat.set(32, 32);
            const groundGeometry = new THREE.PlaneGeometry(100, 100);
            const groundMaterial = new THREE.MeshStandardMaterial({ map: textures.grass });
            const ground = new THREE.Mesh(groundGeometry, groundMaterial);
            ground.rotation.x = -Math.PI / 2;
            ground.receiveShadow = true;
            ground.name = "grass";
            scene.add(ground);

            for (let i = 0; i < 20; i++) {
                const pillarHeight = Math.random() * 5 + 2;
                const pillarGeometry = new THREE.CylinderGeometry(1, 1, pillarHeight, 16);
                const pillarMaterial = new THREE.MeshStandardMaterial({ map: textures.brown });
                const pillar = new THREE.Mesh(pillarGeometry, pillarMaterial);
                pillar.position.set(Math.random() * 80 - 40, pillarHeight / 2, Math.random() * 80 - 40);
                pillar.castShadow = true;
                pillar.receiveShadow = true;
                pillar.name = "pillar";
                scene.add(pillar);
                pillars.push(pillar);
            }

            // Player
            player = new THREE.Object3D();
            player.position.set(0, 1, 5);
            scene.add(player);
            player.add(camera);

            // Gun
            const gunGeometry = new THREE.BoxGeometry(0.1, 0.2, 1);
            const gunMaterial = new THREE.MeshStandardMaterial({ map: textures.gun });
            gun = new THREE.Mesh(gunGeometry, gunMaterial);
            gun.position.set(0.3, -0.2, -0.5);
            camera.add(gun);

            // Tank
            const tankMaterial = new THREE.MeshStandardMaterial({ map: textures.tank });
            const tankBodyGeometry = new THREE.BoxGeometry(4, 2, 6);
            const tankBody = new THREE.Mesh(tankBodyGeometry, tankMaterial);
            tankBody.castShadow = true;
            const tankTurretGeometry = new THREE.BoxGeometry(2, 1.5, 2);
            tankTurret = new THREE.Mesh(tankTurretGeometry, tankMaterial);
            tankTurret.position.y = 1.75;
            tankTurret.castShadow = true;
            tank = new THREE.Object3D();
            tank.add(tankBody);
            tank.add(tankTurret);
            tank.position.set(20, 1, -20);
            scene.add(tank);

            // Enemies
            for (let i = 0; i < 10; i++) {
                if (enemyModel) {
                    const enemy = enemyModel.clone();
                    enemy.position.set(Math.random() * 80 - 40, 0, Math.random() * 80 - 40);
                    enemy.shootCooldown = Math.random() * 3 + 2; // Cooldown between 2-5s
                    enemies.push(enemy);
                    scene.add(enemy);
                }
            }

            // Controls
            document.addEventListener('keydown', onKeyDown);
            document.addEventListener('keyup', onKeyUp);
            document.addEventListener('mousemove', onMouseMove);
            document.addEventListener('mousedown', onMouseDown);
            document.body.requestPointerLock();
        }

        function onKeyDown(event) {
            keys[event.key.toLowerCase()] = true;
            if (event.key.toLowerCase() === 'e') toggleTankMode();
            if (event.code === 'Space' && onGround) {
                playerVelocity.y = 0.25;
                onGround = false;
                if(sounds.jump && !sounds.jump.isPlaying) sounds.jump.play();
            }
        }

        function onKeyUp(event) {
            keys[event.key.toLowerCase()] = false;
        }
        
        function toggleTankMode() { /* ... unchanged ... */ }

        function onMouseMove(event) {
             if (document.pointerLockElement !== document.body) return;
             if (isInTank) {
                tank.rotation.y -= event.movementX * 0.002;
                tankTurret.rotation.y -= event.movementX * 0.002;
             } else {
                player.rotation.y -= event.movementX * 0.002;
                camera.rotation.x -= event.movementY * 0.002;
                camera.rotation.x = Math.max(-Math.PI / 2, Math.min(Math.PI / 2, camera.rotation.x));
             }
        }

        function onMouseDown(event) {
            if (document.pointerLockElement !== document.body) {
                document.body.requestPointerLock();
            } else {
                shoot();
            }
        }
        
        function shoot() {
            if (isInTank) { /* ... unchanged ... */ } 
            else if (ammo > 0) {
                ammo--;
                updateAmmoDisplay();
                isRecoiling = true;
                recoilClock.start();
                if(sounds.gun && !sounds.gun.isPlaying) sounds.gun.play();

                const bulletGeometry = new THREE.SphereGeometry(0.1, 8, 8);
                const bulletMaterial = new THREE.MeshStandardMaterial({ map: textures.bullet });
                const bullet = new THREE.Mesh(bulletGeometry, bulletMaterial);
                const vector = new THREE.Vector3();
                camera.getWorldDirection(vector);
                bullet.position.copy(player.position).add(vector.multiplyScalar(1));
                bullet.velocity = vector.multiplyScalar(50);
                bullets.push(bullet);
                scene.add(bullet);
            }
        }
        
        function createExplosion(position) { /* ... unchanged ... */ }
        function updateAmmoDisplay() { ammoDisplay.textContent = `Ammo: ${ammo}`; }
        function updateHealthDisplay() { healthDisplay.textContent = `Health: ${playerHealth}`; }

        function handlePlayerMovement(delta) {
            const currentSpeed = keys['shift'] ? 0.15 : 0.08;
            const moveDirection = new THREE.Vector3();
            if (keys['w']) moveDirection.z -= 1;
            if (keys['s']) moveDirection.z += 1;
            if (keys['a']) moveDirection.x -= 1;
            if (keys['d']) moveDirection.x += 1;
            moveDirection.normalize().applyEuler(player.rotation).multiplyScalar(currentSpeed);
            
            player.position.x += moveDirection.x;
            player.position.z += moveDirection.z;

            // Simple Collision
            const playerBox = new THREE.Box3().setFromCenterAndSize(player.position, new THREE.Vector3(0.5, 2, 0.5));
            pillars.forEach(pillar => {
                const pillarBox = new THREE.Box3().setFromObject(pillar);
                if (playerBox.intersectsBox(pillarBox)) {
                     player.position.x -= moveDirection.x; // Revert move
                     player.position.z -= moveDirection.z;
                }
            });

            // Gravity and Jumping
            playerVelocity.y += gravity * delta * 60; // scale gravity by delta
            player.position.y += playerVelocity.y;
            
            if (player.position.y < 1) {
                if (playerVelocity.y < 0 && !onGround) {
                     if(sounds.fallinggrass && !sounds.fallinggrass.isPlaying) sounds.fallinggrass.play();
                }
                player.position.y = 1;
                playerVelocity.y = 0;
                onGround = true;
            }
        }

        function handleTankControls() { /* ... unchanged ... */ }

        function updateEnemies(delta) {
             enemies.forEach(enemy => {
                const target = isInTank ? tank.position : player.position;
                enemy.lookAt(target);
                const distance = enemy.position.distanceTo(target);
                if (distance > 15) {
                    const direction = new THREE.Vector3().subVectors(target, enemy.position).normalize();
                    enemy.position.add(direction.multiplyScalar(0.02));
                }
                
                // Enemy Shooting
                enemy.shootCooldown -= delta;
                if(distance < 30 && enemy.shootCooldown <= 0) {
                     if(sounds.enemygun && !sounds.enemygun.isPlaying) sounds.enemygun.play(0.5); // Play a bit quieter
                     const enemyBulletGeometry = new THREE.SphereGeometry(0.1, 8, 8);
                     const enemyBulletMaterial = new THREE.MeshBasicMaterial({color: 0xff0000});
                     const enemyBullet = new THREE.Mesh(enemyBulletGeometry, enemyBulletMaterial);
                     
                     const direction = new THREE.Vector3().subVectors(target, enemy.position).normalize();
                     enemyBullet.position.copy(enemy.position).add(direction);
                     enemyBullet.velocity = direction.multiplyScalar(20);
                     enemyBullets.push(enemyBullet);
                     scene.add(enemyBullet);
                     enemy.shootCooldown = 1.5; // Reset cooldown
                }
            });
        }
        
        function updateGunAnimation() {
            if(isRecoiling) {
                const elapsedTime = recoilClock.getElapsedTime();
                if(elapsedTime < 0.1) {
                    gun.position.z = -0.5 - (elapsedTime * 2);
                } else if(elapsedTime < 0.3) {
                     gun.position.z = -0.7 + (elapsedTime - 0.1) * 1;
                } else {
                    isRecoiling = false;
                    gun.position.z = -0.5;
                    recoilClock.stop();
                }
            }
        }

        function animate() {
            if (isGameOver) return;
            const delta = recoilClock.getDelta(); // Use one clock for delta time
            requestAnimationFrame(animate);

            if (isInTank) {
                handleTankControls();
            } else {
                handlePlayerMovement(delta);
                const distanceToTank = player.position.distanceTo(tank.position);
                promptDisplay.style.display = distanceToTank < 5 ? 'block' : 'none';
                updateGunAnimation();
            }

            updateEnemies(delta);

            // Update Bullets (Player)
            bullets.forEach((bullet, index) => {
                bullet.position.add(bullet.velocity.clone().multiplyScalar(0.016));
                if (bullet.position.distanceTo(player.position) > 100) {
                    scene.remove(bullet);
                    bullets.splice(index, 1);
                }
                enemies.forEach((enemy, enemyIndex) => {
                    if (bullet.position.distanceTo(enemy.position) < 1) {
                        scene.remove(enemy);
                        enemies.splice(enemyIndex, 1);
                        scene.remove(bullet);
                        bullets.splice(index, 1);
                        
                        const ammoDropGeometry = new THREE.BoxGeometry(0.5, 0.5, 0.5);
                        const ammoDropMaterial = new THREE.MeshStandardMaterial({ map: textures.bullet });
                        const ammoDrop = new THREE.Mesh(ammoDropGeometry, ammoDropMaterial);
                        ammoDrop.name = "ammo";
                        ammoDrop.position.copy(enemy.position);
                        scene.add(ammoDrop);
                    }
                });
            });
            
             // Update Enemy Bullets
            enemyBullets.forEach((bullet, index) => {
                bullet.position.add(bullet.velocity.clone().multiplyScalar(delta));
                if(bullet.position.distanceTo(player.position) < 1 && !isInTank) {
                    playerHealth -= 10;
                    updateHealthDisplay();
                    if(playerHealth <= 0) {
                        isGameOver = true;
                        gameOverScreen.style.display = 'flex';
                        document.exitPointerLock();
                    }
                    scene.remove(bullet);
                    enemyBullets.splice(index, 1);
                } else if (bullet.position.distanceTo(tank.position) > 150) {
                    scene.remove(bullet);
                    enemyBullets.splice(index, 1);
                }
            });


            // Player-Ammo Drop Collision
            if (!isInTank) {
                 scene.children.forEach((object) => {
                    if (object.name === "ammo" && player.position.distanceTo(object.position) < 1.5) {
                        ammo += 10;
                        updateAmmoDisplay();
                        scene.remove(object);
                    }
                });
            }

            renderer.render(scene, camera);
        }

        window.addEventListener('resize', () => { /* ... unchanged ... */ });
    </script>
</body>
</html>